---
title: "Data prep and analysis of skilled nursing facilities"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", linewidth  = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", linewidth = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#654C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4565b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4565b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Shapefiles/County shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```


# Data Prep

First, let's load in the master file.

```{r load master file}
master.original <- read_csv("Data/Facilities/Master-provider-directory-2005-2024.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.original %>%
  names() %>%
  kable()

master.age.65plus.county <- read_csv("Data/Population/Age/Master-age-65plus-county.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.age.projections.65plus.county <- read_csv("Data/Population/Age/Master-age-projections-65plus-county.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

<br>

There are `r comma(ncol(master.original))` columns in the dataset and `r comma(nrow(master.original))` rows. Each row is a facility tied to a specific year.

The following table defines all of the columns.

```{r varaiable definition table}
field.outline <- read_excel("Data/Facilities/Field outline.xlsx") %>%
  as_tibble()

datatable(field.outline, class = "cell-border stripe", filter = "top", rownames = FALSE)

```

<br>

With this exploration, the primary data we want are only the skilled nursing facilities and their capacity to provide nursing home beds. This dataset is a bit confusing to try and figure out which column is actually measuring beds. Here are all the columns that seem to have something to do with capacity for which we are concerned here;

* NH_BEDS: State licensed, number of nursing home beds
* SNF_BEDS: Federal medicare, number of skilled nursing facility beds
* SNFNF_BEDS: Federal medicare/medicaid, number of dual skilled nursing facility and nursing facility beds
* NF1_Beds: Federal Medicaid, number of nursing facility beds (Nursing home)
* NF2_Beds: Federal Medicaid, number of nursing facility beds (Boarding care home)

I think we need better descriptions here to decipher what is going on because some of these a sub-categories of others. For example, NH_BEDS seems to be the sum of SNF_BEDS and SNFNF_Beds.

* NH_BEDS = SNF_BEDS + SNFNF_BEDS + NF1_BEDS

So what is the difference between those three that add up to NH_BEDS? 

* SNF_BEDS =  are only medicare eligible beds.
* SNFNF_BEDS =  are medicare and medicaid eligible beds.
* NF1_BEDS = are only medicaid beds

And all of these are located in skilled nursing facilities. NF2_BEDS is not included in the NH_BEDS. Why? These beds are not in a skilled nursing facility, but rather in a "group home" which is a small, private facility. 

So with this figured out, let's create a dataset that has all five of these columns because it will be good to be able to split these out further in the analysis.

```{r create master snf beds}
master.snf <- master.original %>%
  select(year, LIC_TYPE, NH_BEDS, SNF_BEDS, SNFNF_BEDS, NF1_BEDS, NF2_BEDS, HFID, NAME, CITY, STATE, ZIP, COUNTY_NAME, countyfp, Dem_Desc, edr, planning.region)

master.snf
```

<br>

# Beds

In this section we explore trends in the number of beds available each year by region - from total beds, to whether there are differences in the payment eligibility for beds, and the number of swing beds available in critical access hospitals.

## Total beds{.tabset}

This section will explore what changes have taken place in the number of licensed skilled nursing beds by region and rurality. For this exploration we will use the sum of NH_BEDS + NF2_BEDS.

```{r sn beds master}
nh.nf2.beds.master <- master.snf %>%
  mutate(nh.nf2.beds = NH_BEDS + NF2_BEDS) %>%
  filter(nh.nf2.beds > 0)

names(nh.nf2.beds.master)

```

There are `r comma(nrow(nh.nf2.beds.master))` facilities with these types of beds available in Minnesota.


<br>

### Minnesota

The number of nursing home beds has decreased 33% since 2005 in the state of Minnesota. Overall in Minnesota, the number of skilled nursing home and facility beds available has declined by 33.3%, from 37,718 beds in 2005 to 25,173 in 2024.

The largest percentage declines have occurred in Northwest (43.4%) and Southwest Minnesota (-38.3%). In particular, the EDRs 5 (-55%) and 4 (-40%) in Northwest Minnesota, and EDRs 8 (-40%) and 9 (-38%) in Southwest Minnesota. 

Some of the counties with very high percentage declines include;

* Cass (-93%)
* Grant (-65%)
* Swift (-69%)
* Pine (-65%)
* Faribault (-63%)

<br>

```{r nh and nf2 beds mn, echo = FALSE}
nh.nf2.beds.mn <- nh.nf2.beds.master %>%
  group_by(year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)],
         data_id = as.character(seq(n()))) 

nh.nf2.beds.mn.plot <- ggplot(nh.nf2.beds.mn, aes(year, nh.nf2.beds)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(y = nh.nf2.beds / 2, label = paste("% change\nsince 2005\n", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = "")), color = "black") +
  geom_label(aes(label = comma(nh.nf2.beds)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of nursing home beds (nursing and boarding homes)")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.mn.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

### Planning Region

The planning regions with the largest percentage declines in the number of beds are Northwest (-43%) and Southwest (-38%). The lowest was actually in Central Minnesota with a decline of -25.2%. 

<br>

```{r nh and nf2 beds pr, echo = FALSE}
nh.nf2.beds.pr <- nh.nf2.beds.master %>%
  filter(!is.na(planning.region)) %>%
  group_by(year, planning.region) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.pr.plot <- ggplot(data = filter(nh.nf2.beds.pr, year != 2005), aes(as.character(year), nh.nf2.beds.pct.change)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(planning.region, "\n", "Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(y = nh.nf2.beds.pct.change / 2, label = percent(nh.nf2.beds.pct.change, accuracy = .1)), color = "black") +
  labs(x="", y = "", color="", title = "Percent change in the number of nursing home beds (nursing and\nboarding homes) since 2005")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = color.pr) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

### EDR

These EDRs all have declines in the number of beds that exceed the state decline;

* EDR 5 - North Central: -55%
* EDR 4 - West Central: -40%
* EDR 7E - East Central: -37%
* EDR 8 - Southwest: -40%
* EDR 9 - South Central: -38%

These EDRs reside in either Norhwest or Southwest Minnesota.

<br>

```{r nh and nf2 beds edr, echo = FALSE}
nh.nf2.beds.edr <- nh.nf2.beds.master %>%
  filter(!is.na(edr)) %>%
  group_by(year, edr, planning.region) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(edr, planning.region) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.edr.plot <- ggplot(data = filter(nh.nf2.beds.edr, year != 2005), aes(as.character(year), nh.nf2.beds.pct.change, fill = edr, group = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(edr, "\n", "Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(nh.nf2.beds.pct.change, accuracy = .1)), color = "black", position = position_dodge(width = .9), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent change in the number of nursing home beds (nursing and\nboarding homes) since 2005")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = color.edr,
                    guide = guide_legend(ncol = 3)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

### County

This clearly shows that the more rural a group of counties is, the larger the decline in the number of licensed beds.

<br>

```{r nh and nf2 beds county, echo = FALSE}
nh.nf2.beds.county <- nh.nf2.beds.master %>%
  filter(!is.na(countyfp)) %>%
  group_by(year, countyfp, COUNTY_NAME) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(countyfp, COUNTY_NAME) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  filter(year == max(year)) %>% 
  left_join(mn_counties[,c(5,7)], by = "countyfp") %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.county.map <- ggplot(nh.nf2.beds.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = nh.nf2.beds.pct.change, data_id = countyfp, tooltip = paste(COUNTY_NAME, "\nNumber of beds: ", comma(nh.nf2.beds), "\nPercent change in the number of beds since 2005: ", percent(nh.nf2.beds.pct.change, accuracy = .1) , sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "Reds", direction = -1, labels = scales::percent) +
  labs(title = "Percent change in number of beds since 2005") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = nh.nf2.beds.county.map, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  



```


<br>

### RUCA

This clearly shows that the more rural a group of counties is, the larger the decline in the number of licensed beds.

<br>

```{r nh and nf2 beds ruca, echo = FALSE}
nh.nf2.beds.ruca <- nh.nf2.beds.master %>%
  filter(!is.na(Dem_Desc)) %>%
  group_by(year, Dem_Desc) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.ruca.plot <- ggplot(data = filter(nh.nf2.beds.ruca, year != 2005), aes(as.character(year), nh.nf2.beds.pct.change)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Dem_Desc, "\n", "Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(nh.nf2.beds.pct.change, accuracy = .1)), color = "black", position = position_dodge(width = .9), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent change in the number of nursing home beds (nursing and\nboarding homes) since 2005")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = color.ruca,
                    guide = guide_legend(ncol = 3)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

## Availability per 65+ resident{.tabset}

The average age of nursing home residents is about 83, however, rural folks tend to get sicker earlier so let's use the 65+ age cohort to measure the ratio of residents per bed capacity. 

In addition, we have access to the number of 65+ projections for each county using the MN State Demographic Center estimates. I will include those in there. For those, we will just assume that the bed capacity will remain constant from 2024 onwards.

The charts below show that there has been a significant increase in the number of 65+ individuals per bed capacity all across Minnesota. In fact, not a single county has less 65+ per bed capacity in 2024 compared to 2005. And the number of 65+ per bed will peak across the state between 2030 and 2035.

However, some areas have higher 65+ individuals per bed capacity than others. The seven county metro has the highest out of all the planning regions, but this is largely driven by four counties - Anoka, Washington, Dakota, Carver. In Greater Minnesota, the highest number of 65+ per bed capacity is in the central lakes - Cass, Crow Wing and Hubbard. 

Overall, Southwest Minnesota seems to have the lowest values of 65+ per bed capacity.

<br>

```{r combine snf beds and age 65 plus, echo=FALSE}
age65plus.projections.county <- master.age.projections.65plus.county %>%
  filter(year %in% c(2030, 2035, 2040))

age.65plus.old.projections.county <- age65plus.projections.county %>%
  rbind(master.age.65plus.county)

nh.nf2.beds.age.65plus.county <- nh.nf2.beds.master %>%
  filter(!is.na(countyfp)) %>%
  group_by(year, countyfp, COUNTY_NAME) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(countyfp, COUNTY_NAME) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  filter(year > 2005) %>%
  select(year, countyfp, COUNTY_NAME, nh.nf2.beds) %>%
  pivot_wider(names_from = year, values_from = nh.nf2.beds) %>%
  mutate(`2030` = `2024`,
         `2035` = `2024`,
         `2040` = `2024`) %>%
  pivot_longer(names_to = "year", values_to = "nh.nf2.beds", `2010`:`2040`) %>%
  mutate(year = as.integer(year)) %>%
  left_join(age.65plus.old.projections.county, by = c("countyfp", "year")) 

```

<br>

### Minnesota

The number of people 65+ per beds has increased significantly since 2005. By 2024 it increased from 20.4 people 65+ per bed capacity to 41.9 people 65+.

<br>

```{r 65 plus per nh nf2 bed MN, echo=FALSE}
nh.nf2.beds.age.65plus.mn <- nh.nf2.beds.age.65plus.county %>%
  group_by(year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() 

nh.nf2.beds.age.65plus.mn.plot <- ggplot(nh.nf2.beds.age.65plus.mn, aes(as.character(year), age.65plus.nh.nf2.beds)) +
  geom_col_interactive(position = "dodge", aes(data_id = year, tooltip = paste("Minnesota", "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%\nfrom 2010 to 2024")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.mn.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```
<br>

### Planning Region

The largest changes in the number of 65+ individuals per nh and NF2 bed capacity has been in the seven-county metro. Southwest has had the lowest.

<br>

```{r 65 plus per nh nf2 bed pr, echo=FALSE}
nh.nf2.beds.age.65plus.pr <- nh.nf2.beds.age.65plus.county %>%
  group_by(planning.region, year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.age.65plus.pr.plot <- ggplot(nh.nf2.beds.age.65plus.pr, aes(as.character(year), age.65plus.nh.nf2.beds)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

### EDR

There has been some EDR's in Greater Minnesota that are experiencing high levels of individuals 65 or older per NH and NF2 bed capacity;

* EDR 2: Has been high for a while and is currently at 19 individuals per available capacity.
* EDR 5: Super high ratio - currently at 25 individuals per 1 NH and NF2 bed capacity.
* EDR 7E: 21 individuals per 1 bed capacity
* EDR 7W: 19 individuals per 1 bed capacity

Southwest is surprisingly low. 


<br>

```{r 65 plus per nh nf2 bed edr, echo=FALSE}
nh.nf2.beds.age.65plus.edr <- nh.nf2.beds.age.65plus.county %>%
  group_by(edr, planning.region, year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.age.65plus.edr.plot <- ggplot(nh.nf2.beds.age.65plus.edr, aes(as.character(year), age.65plus.nh.nf2.beds, group = edr, fill = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%")+
  scale_y_continuous(labels=scales::comma)+
  scale_fill_manual(values = color.edr,
                    guide = guide_legend(ncol = 3)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

### County

At the county level, there is a considerable higher number of 65 residents in the central lakes region per 1 Nh and NF2 bed capacity. 

* Hubbarb: 114
* Cass: 270.6
* Crow Wing: 103.0
* Pine: 1387

In addition, a couple of the suburbs have significantly higher number of 65+ per bed capacity.

* Anoka: 147.7
* Washington: 80.4
* Dakota: 89.1
* Carver: 104.3

<br>

```{r 65 plus per nh nf2 bed county, echo=FALSE}
nh.nf2.beds.age.65plus.county.map <- nh.nf2.beds.age.65plus.county %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds,
         age.65plus.nh.nf2.beds.bins = cut(age.65plus.nh.nf2.beds,
                                           breaks = c(0, 20, 40, 60, 80, 2000),
                                           labels = c("1-20 individuals 65+", "20-40 individuals 65+", "40-60 individuals 65+", "60-80 individuals 65+", "More than 80 individuals 65+")))%>%
group_by(countyfp) %>%
  mutate(better.worse = ifelse(age.65plus.nh.nf2.beds > age.65plus.nh.nf2.beds[year == min(year)], "Worse", "Better")) %>%
  ungroup() %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")


nh.nf2.beds.age.65plus.county.map.plot <- ggplot(data = filter(nh.nf2.beds.age.65plus.county.map, year == 2024)) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = age.65plus.nh.nf2.beds.bins, data_id = countyfp, tooltip = paste(COUNTY_NAME, "\nYear: ", year, "\nIndividuals aged 65 plus: ", comma(age.65plus), "\nNumber of NH and NF2 bed capacity: ", comma(nh.nf2.beds), "\nNumber of 65 plus per 1 bed: ", comma(age.65plus.nh.nf2.beds, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "Reds")) +
  labs(title = "Number of individuals 65 or older per 1 NH and NF2 bed capacity",
       subtitle = "Highest number of 65+ in 2024 is in the central lakes and suburbs.") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))
   

girafe(ggobj = nh.nf2.beds.age.65plus.county.map.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
```

<br>

### RUCA

As expected, the more rural, the less people 65+ per bed capacity. 

<br>

```{r 65 plus per nh nf2 bed ruca, echo=FALSE}
nh.nf2.beds.age.65plus.ruca <- nh.nf2.beds.age.65plus.county %>%
  group_by(Dem_Desc, year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.age.65plus.ruca.plot <- ggplot(nh.nf2.beds.age.65plus.ruca, aes(as.character(year), age.65plus.nh.nf2.beds)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## Medicare vs Medicaid beds

The next question is whether any type of bed with attached payment eligibility has changed more than another. In the previous sections, we measured capacity by combining NH_Beds and NH2_Beds. NH_Beds was actually the total of SNF_Beds, SNFNF_Beds, and NF1_Beds. 

For this we will break out all 4 categories separately to see if any of them are seeing significant declines or increases. Here, again, are the definitions of these bed types;

* SNF_BEDS: Federal medicare, number of skilled nursing facility beds
* NF1_Beds: Federal medicaid, number of nursing facility beds (Nursing home)
* NF2_Beds: Federal medicaid, number of nursing facility beds (Boarding care home)
* SNFNF_BEDS: Federal medicare/medicaid, number of dual skilled nursing facility and nursing facility beds

Honestly, I think it's going to be easier if I relabel these columns so they match their definitions.

* SNF_BEDS = medicare.only
* NF1_BEDS = medicaid.only.nursing
* NF2_BEDS = medicaid.only.boarding
* SNFNF_BEDS = medicare.medicaid

<br>

```{r master care vs caid capacity}
master.caid.care <- master.original %>%
  select(year, LIC_TYPE, SNF_BEDS, SNFNF_BEDS, NF1_BEDS, NF2_BEDS, HFID, NAME, CITY, STATE, ZIP, COUNTY_NAME, countyfp, Dem_Desc, edr, planning.region) %>%
  rename(medicare.only = SNF_BEDS,
         medicaid.only.nursing = NF1_BEDS,
         medicaid.only.boarding = NF2_BEDS,
         medicare.medicaid = SNFNF_BEDS)

names(master.caid.care)

head(master.caid.care)
```

### Proportion of payer type{.tabset}

Let's first take a look at what the proportion of payer type there is and whether it's about equal across the regions in Minnesota. We will use them most recent year.

The breakdowns below show that nearly the entire state has 100% of their beds as medicare and medicaid eligible. However, Ramsay and Hennepin have lower share that are dual eligible with medcaid only (boarding homes) being a bit larger of a percentage. Rosseau county is another outlier where they have 85% of their beds as dual eligible, and the rest are medcaid only (nursing home) eligible.

<br>

#### Minnesota

The chart below shows that, by far, the largest share of beds are medicare and medicaid type. It's 95% of the beds capacity in Minnesota.

<br>

```{r care vs caid capacity Minnesota, echo=FALSE}
caid.care.mn <- master.caid.care %>%
  group_by(year) %>%
  summarize(medicare.only = sum(medicare.only, na.rm = TRUE),
            medicaid.only.nursing = sum(medicaid.only.nursing, na.rm = TRUE),
            medicaid.only.boarding = sum(medicaid.only.boarding, na.rm = TRUE),
            medicare.medicaid = sum(medicare.medicaid, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_longer(names_to = "bed.type", values_to = "beds", 2:ncol(.)) %>%
  group_by(bed.type) %>%
  mutate(pct.change.2005 = (beds - beds[year == min(year)]) / beds[year == min(year)]) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(pct.share = beds / sum(beds)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

caid.care.mn.plot <- ggplot(caid.care.mn, aes(as.factor(year), pct.share, fill = bed.type, group = bed.type)) +
  geom_bar(stat = "identity", position = "dodge", aes(data_id = data_id, tooltip = paste(year, "\nBed type: ", bed.type, "\nNumber of beds: ", comma(beds), "\nPercent share of beds: ", percent(pct.share, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct.share, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of skilled nursing beds")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = caid.care.mn.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

#### Planning Region

The chart below shows that the dual payment type (medicare and medicaid) are even a larger share of the total beds outside of the seven metro. The seven county metro is where the bed type can be medicare or medicaid only. And mostly, its the medicaid only beds provided at boarding institutions.

<br>

```{r care vs caid capacity planning region, echo=FALSE}
caid.care.pr <- master.caid.care %>%
  filter(!is.na(planning.region)) %>%
  group_by(year, planning.region) %>%
  summarize(medicare.only = sum(medicare.only, na.rm = TRUE),
            medicaid.only.nursing = sum(medicaid.only.nursing, na.rm = TRUE),
            medicaid.only.boarding = sum(medicaid.only.boarding, na.rm = TRUE),
            medicare.medicaid = sum(medicare.medicaid, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_longer(names_to = "bed.type", values_to = "beds", 3:ncol(.)) %>%
  group_by(bed.type, planning.region) %>%
  mutate(pct.change.2005 = (beds - beds[year == min(year)]) / beds[year == min(year)]) %>%
  ungroup() %>%
  group_by(year, planning.region) %>%
  mutate(pct.share = beds / sum(beds)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

caid.care.pr.plot <- ggplot(caid.care.pr, aes(as.factor(year), pct.share, fill = bed.type, group = bed.type)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_bar_interactive(stat = "identity", position = "dodge", aes(data_id = data_id, tooltip = paste(year, "\n", planning.region, "\nBed type: ", bed.type, "\nNumber of beds: ", comma(beds), "\nPercent share of beds: ", percent(pct.share, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct.share, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of skilled nursing beds")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = caid.care.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

#### County map

Since the dual eligible beds make up such a large percentage, we are going to skip the EDR breakdown and just look at what the proportion looks like by county. 

The maps below show that nearly the entire state has 100% of their skilled nursing beds as medicare and medicaid eligible. Hennepin and Ramsay have it split a bit more with 6% of their beds as either medicare only or medicaid only (boarding homes). Rosseau is also interesting. 85% of their beds are medicare and medicaid eligible, but they also have a larger 15% of their beds as medicaid only (nursing homes) eligible. It's a bit of an outlier compared to the rest of the state.

<br>

```{r caid care county, echo=FALSE}
caid.care.county <- master.caid.care %>%
  filter(!is.na(countyfp)) %>%
  group_by(year, countyfp, COUNTY_NAME) %>%
  summarize(medicare.only = sum(medicare.only, na.rm = TRUE),
            medicaid.only.nursing = sum(medicaid.only.nursing, na.rm = TRUE),
            medicaid.only.boarding = sum(medicaid.only.boarding, na.rm = TRUE),
            medicare.medicaid = sum(medicare.medicaid, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_longer(names_to = "bed.type", values_to = "beds", 4:ncol(.)) %>%
  group_by(bed.type, countyfp, COUNTY_NAME) %>%
  mutate(pct.change.2005 = (beds - beds[year == min(year)]) / beds[year == min(year)]) %>%
  ungroup() %>%
  group_by(year, countyfp, COUNTY_NAME) %>%
  mutate(pct.share = beds / sum(beds)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         bed.type = as.factor(bed.type)) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp") 

medicare.medicaid.county <- caid.care.county %>%
  filter(bed.type == "medicare.medicaid") %>%
  mutate(pct.share.bins = cut(pct.share,
                                      breaks = c(0, .85, .9, .95, .999999999, 1.5),
                                      labels = c("80% to 85%", "85% to 90%", "90% to 95%", "95% to 99%", "100%")))

medicaid.only.nursing.county <- caid.care.county %>%
  filter(bed.type == "medicaid.only.nursing") %>%
  mutate(pct.share.bins = cut(pct.share,
                              breaks = c(-1, 0, .03, .06, .09, .2),
                              labels = c("0%", "1% to 3%", "3% to 6%", "6% to 9%", "9% to 16%")))

medicaid.only.boarding.county <- caid.care.county %>%
  filter(bed.type == "medicaid.only.boarding") %>%
  mutate(pct.share.bins = cut(pct.share,
                              breaks = c(-1, 0, .03, .06, .09, .2),
                              labels = c("0%", "1% to 3%", "3% to 6%", "6% to 9%", "9% to 16%")))

medicare.only.county <- caid.care.county %>%
  filter(bed.type == "medicare.only") %>%
  mutate(pct.share.bins = cut(pct.share,
                              breaks = c(-1, 0, .03, .06, .09, .2),
                              labels = c("0%", "1% to 3%", "3% to 6%", "6% to 9%", "9% to 16%")))

title <- ggdraw() + 
  draw_label(
    "Percent share of total beds, 2024",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(-10, 0, 0, 0)
  )


medicare.medicaid.county.plot <- ggplot(data = filter(medicare.medicaid.county, year == max(year))) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.share.bins, data_id = data_id, tooltip = paste(COUNTY_NAME, "\n", year, "\nBed payment type: ", bed.type, "\nNumber of beds: ", comma(beds), "\nProportion of total beds: ", percent(pct.share, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 3)) +
  labs(title = "Medicare and medicaid ") +
  theme(legend.position = "bottom")

medicare.only.county.plot <- ggplot(data = filter(medicare.only.county, year == max(year))) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.share.bins, data_id = data_id, tooltip = paste(COUNTY_NAME, "\n", year, "\nBed payment type: ", bed.type, "\nNumber of beds: ", comma(beds), "\nProportion of total beds: ", percent(pct.share, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 2)) +
  labs(title = "Medicare only") +
  theme(legend.position = "bottom")

medicaid.only.nursing.county.plot <- ggplot(data = filter(medicaid.only.nursing.county, year == max(year))) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.share.bins, data_id = data_id, tooltip = paste(COUNTY_NAME, "\n", year, "\nBed payment type: ", bed.type, "\nNumber of beds: ", comma(beds), "\nProportion of total beds: ", percent(pct.share, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 2)) +
  labs(title = "Medicaid only (nursing homes)") +
  theme(legend.position = "bottom")

medicaid.only.boarding.county.plot <- ggplot(data = filter(medicaid.only.boarding.county, year == max(year))) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.share.bins, data_id = data_id, tooltip = paste(COUNTY_NAME, "\n", year, "\nBed payment type: ", bed.type, "\nNumber of beds: ", comma(beds), "\nProportion of total beds: ", percent(pct.share, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 2)) +
  labs(title = "Medicaid only (boarding homes)") +
  theme(legend.position = "bottom")

title <- ggdraw() + 
  draw_label(
    "Percent share of total beds, 2024",
    fontface = 'bold',
    x = 0,
    hjust = 0,
    size = 20
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 0)
  )

girafe( ggobj =  plot_grid(title, NULL, medicare.medicaid.county.plot, medicare.only.county.plot, NULL, NULL, medicaid.only.nursing.county.plot, medicaid.only.boarding.county.plot, ncol = 2, rel_heights = c(.1,1,.1,1)), height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))




```

<br>

### Trends by payment eligibility

Since nearly all counties only have 100% of their beds as dual eligible, let's focus only on Roseau, St. Louis and Olmsted counties. Questions that rise are whether they are experiencing declines in only the dual eligible beds or is it pretty equal across the payment eligibility.

The chart below shows that the dual eligible beds were the most common to decline in capacity. In St. Louis county they've had a decline of 541 dual eligible beds since 2005, 20 beds in Roseau, and 60 beds in Olmsted.

Interestingly, Roseau also experienced a decline of 20 beds that were medicaid only within boarding home beds. 

<br>

```{r non dual beds}
non.dual.counties <- caid.care.county %>%
  filter(COUNTY_NAME %in% c("Roseau", "St. Louis", "Sherburne", "Ramsey", "Hennepin", "Dakota", "Olmsted")) %>%
  select(year, countyfp, COUNTY_NAME, bed.type, beds, geometry) %>%
  group_by(countyfp, COUNTY_NAME, bed.type) %>%
  mutate(bed.type.change.n = beds - beds[year == min(year)],
         bed.type.change.pct = (beds - beds[year == min(year)]) / beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

names(non.dual.counties)

non.dual.counties.plot <- ggplot(filter(non.dual.counties, year == max(year) & COUNTY_NAME %in% c("Roseau", "St. Louis", "Olmsted")), aes(bed.type, bed.type.change.pct, fill = COUNTY_NAME, group = COUNTY_NAME)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(COUNTY_NAME, "\n", year, "\nBed type: ", bed.type, "\nNumber of beds: ", beds, "\nChange in number of beds since 2005: ", comma(bed.type.change.n), "\nPercent change since 2005: ", percent(bed.type.change.pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(bed.type.change.pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Change in number of beds since 2005 by bed payment type")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 7, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = non.dual.counties.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

## Swing beds{.tabset}

One other aspect worth exploring is the trends in the number of swing beds available in rural Minnesota. 

A swing bed is a service that rural hospitals and critical access hospitals (CAHs) with a Medicare provider agreement provide that allows a patient to transition from acute care to skilled nursing facility (SNF) care without leaving the hospital. This allows a patient to continue receiving services in the hospital even though acute care is no longer required.

State law allows Minnesota Health Care Programs (MHCP) payments for swing bed services provided by a designated licensed hospital, if the hospital meets the following criteria:

* The hospital is the sole community provider, or is a public hospital owned by a government entity with 15 or fewer acute care beds
* The MHCP member requires skilled nursing care per Medicaid guidelines
* A nursing home bed is not available within 25 miles of the facility
* The member is transferred from an acute care hospital bed and acute care is no longer needed
* The member must receive a preadmission screening before placement as specified in the Preadmission Screening section of this manual section.

Okay, so let's load up the master data and see what we have here. The column "SWING" identifies whether the facility has a medicare certified swing bed. So let's filter out everything so we only have those facilities.

<br>

# Facilities

Okay, next let's see if there are any changes to the number of facilities. Essentially, is the decline of bed capacity due to a decline in facilities, or is it facilities themselves that are shutting down some of their wings. This matters because if the facilities still exist, it means that it's possible regions could see an increase in beds if needed. Let's first focus on the decline in total facilities first.

## Change in number of facilities{.tabset}

In order to figure out facilities that over skilled nursing beds, I'm going to filter for facilities that have a value greater than 0 in the following columns;

* NH_Beds, or
* NF2_Beds

<br>

```{r exploring facility data}
snf.fac <- master.snf %>%
  select(year, HFID, NAME, NH_BEDS, NF2_BEDS, COUNTY_NAME, countyfp, Dem_Desc, edr, planning.region) %>%
  filter(NH_BEDS > 0 | NF2_BEDS > 0)

head(snf.fac)

names(snf.fac)

```

<br>

The object snf.fac has `r comma(nrow(snf.fac))` rows. Each row is a unique HFID for each year that also has 1 or more skilled nursing beds.

The charts below breakdown the number of facilities by region.

In summary, they show that areas outside of the seven county metro are experiencing the largest percentage decline in the number of facilities that offer skilled nursing beds.

<br>

### Minnesota

The number of facilities offering skilled nursing beds has declined in Minnesota from 415 in 2005 to 351 in 2024. This is a 15% decline.

<br>

```{r facilities mn, echo=FALSE}
snf.fac.mn <- snf.fac %>%
  group_by(year) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct.change = (n - n[year == min(year)]) / n[year == min(year)],
         data_id = seq(n()))

snf.fac.mn.plot <- ggplot(snf.fac.mn, aes(year, n)) +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nNumber of facilities: ", comma(n), "\nPercent change since 2005: ", percent(pct.change, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Number of facilities with skilled nursing beds", subtitle = "The number of facilities has decreased by 15% since 2005.")+
  geom_label_repel(aes(label = comma(n)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = snf.fac.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### Planning region

Interestingly, the largest declines have occurred outside the seven county metro, except for Central. The larges decline has taken place in Northwest Minnesota with a decline of 22.1%, followed by Southweste with 20.3%.

<br>

```{r facilities pr, echo=FALSE}
snf.fac.pr <- snf.fac %>%
  group_by(planning.region, year) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(pct.change = (n - n[year == min(year)]) / n[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

snf.fac.pr.plot <- ggplot(snf.fac.pr, aes(year, pct.change, color = planning.region)) +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nNumber of facilities: ", comma(n), "\nPercent change since 2005: ", percent(pct.change, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Number of facilities with skilled nursing beds", subtitle = "The largest percentage declines in the number of facilities has\ndecreased more severely in rural Minnesota.")+
  geom_label_repel(data = filter(snf.fac.pr, year == max(year)), aes(label = percent(pct.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = snf.fac.pr.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### EDR

The breakdown by EDR shows a mixed bag. It definitely shows that the most rural EDRs typically have the largest declines. For example, in the Central region, the largest declines have taken place in EDR 7E and EDR 6E, while EDR 7W which has St. Cloud has actually increased in the number of facilities. 

Meanwhile, in Southwest MN the largest declines occurred in Southwest, and EDR 9 (which has Mankato) while EDR 6W has the smallest decline. Weird.

Another thing worth mentioning is that both EDR 1 and 8, which are in the very corners of western Minnesota, have very significant declines. Could this be due to their proximity to North Dakota and South Dakota and their major cities?

<br>

```{r facilities edr, echo=FALSE}
snf.fac.edr <- snf.fac %>%
  group_by(edr, planning.region, year) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(edr) %>%
  mutate(pct.change = (n - n[year == min(year)]) / n[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

snf.fac.edr.plot <- ggplot(snf.fac.edr, aes(year, pct.change, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nNumber of facilities: ", comma(n), "\nPercent change since 2005: ", percent(pct.change, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Number of facilities with skilled nursing beds", subtitle = "The largest percentage declines in the number of facilities has\ndecreased more severely in rural Minnesota.")+
  geom_label_repel(data = filter(snf.fac.edr, year == max(year)), aes(label = percent(pct.change, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 2)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = snf.fac.edr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

### Counties

<br>

```{r facilities counties, echo=FALSE}
snf.fac.county <- snf.fac %>%
  group_by(COUNTY_NAME, countyfp, year) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(COUNTY_NAME, countyfp) %>%
  mutate(pct.change = (n - n[year == min(year)]) / n[year == min(year)]) %>%
  ungroup() %>%
  group_by(COUNTY_NAME, countyfp) %>%
  mutate(label = paste("Facilities 2005: ", n[year == min(year)], "\nFacilities 2024: ", n[year == max(year)], sep = "")) %>%
  filter(year == max(year)) %>%
  mutate(pct.change.bins = cut(pct.change,
                               breaks = c(-1, -.5, -.25, -.0000000001, 0, 1),
                               labels = c("-50% or greater", "-50% to -25%", "-25% to -1%", "No change", "Increase in number of facilities"))) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")


snf.fac.county.plot <- ggplot(snf.fac.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.change.bins, data_id = countyfp, tooltip = paste(COUNTY_NAME, "\n", label, "\nChange since 2005: ", percent(pct.change, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("#d73027", "#fc8d59", "#fee090", "white", "#91bfdb")) +
  labs(title = "Change in number of facilities with skilled nursing beds",
       subtitle = "The highest percentage of closures are occurring in rural Minnesota.") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 15))



girafe(ggobj = snf.fac.county.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

## Bed declines: closure or shinkage{.tabset}

So, the big question is whether the large declines in beds is due to facilities closing or due to facilities choosing to offer less beds, and whether geography/rurality matters.

So how the heck do I do that? I need to measure the number and percentage of bed declines into two categories - declines due to facilities that closed, and declines in facilities that are still open. 

* New facility: beds in 2005 is NA and has value in 2024.
* Shrink: Beds in 2005 greater than 0 and is greater than 2024 number of beds.
* Closure: Beds in 2005 greater than 0 and is NA in 2024.

<br>

```{r bed change due to closures or shrinkage}
fac.nh.nf2.beds.2005 <- snf.fac %>%
  filter(year == min(year)) %>%
  mutate(nh.nf2.beds.2005 = NH_BEDS + NF2_BEDS) %>%
  select(HFID, NAME, nh.nf2.beds.2005, countyfp)

fac.nh.nf2.beds.2024 <- snf.fac %>%
  filter(year == max(year)) %>%
  mutate(nh.nf2.beds.2024 = NH_BEDS + NF2_BEDS) %>%
  select(HFID, NAME, nh.nf2.beds.2024, countyfp) 

fac.nh.nf2.beds.2005.2024 <- fac.nh.nf2.beds.2005 %>%
  full_join(fac.nh.nf2.beds.2024, by = c("HFID", "countyfp")) %>%
  mutate(shrunk.closure = ifelse(nh.nf2.beds.2005 > nh.nf2.beds.2024, "Shrink", 99),
         shrunk.closure = ifelse(nh.nf2.beds.2005 == nh.nf2.beds.2024, "No change", shrunk.closure),
         shrunk.closure = ifelse(is.na(nh.nf2.beds.2005) & nh.nf2.beds.2024 > 0, "New facility", shrunk.closure),
          shrunk.closure = ifelse(!is.na(nh.nf2.beds.2005) & nh.nf2.beds.2005 < nh.nf2.beds.2024, "Expansion", shrunk.closure),
         shrunk.closure = ifelse(!is.na(nh.nf2.beds.2005) & nh.nf2.beds.2005 > 0 & is.na(nh.nf2.beds.2024), "Closure", shrunk.closure),
         nh.nf2.beds.2005 = ifelse(is.na(nh.nf2.beds.2005), 0, nh.nf2.beds.2005),
         nh.nf2.beds.2024 = ifelse(is.na(nh.nf2.beds.2024), 0, nh.nf2.beds.2024),
         bed.change = nh.nf2.beds.2024 - nh.nf2.beds.2005) %>%
  left_join(counties.regions, by = "countyfp")
```

<br>

### Minnesota

The chart below shows that 56% of the reduction in skilled nursing facilities is due to facilities shrinking the number of beds they have available. 44% of the reduction in beds is due to facilities closing.

<br>

```{r bed change due to closures or shrinkage MN, echo=FALSE}
bed.change.shrink.mn <- fac.nh.nf2.beds.2005.2024 %>%
  filter(shrunk.closure %in% c("Shrink", "Closure")) %>%
  group_by(shrunk.closure) %>%
  summarize(bed.change = sum(bed.change)) %>%
  ungroup() %>%
  mutate(pct = bed.change / sum(bed.change),
         data_id = seq(n()))

bed.change.shrink.mn.plot <- ggplot(bed.change.shrink.mn, aes(shrunk.closure, pct)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Minnesota", "\n2024", "\nBed reduction due to ", shrunk.closure, ": ", comma(bed.change), "\nPercent of total decline: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of bed reduction.", subtitle = "A large percentage of the reduction in skilled nursing beds is\nfrom facilities shrinking.")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = bed.change.shrink.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### Planning Region

Looking at the reductions due to closures and shrinkages by planning region, there are two outliers when compared to the statewide numbers. Northeast Minnesota has a significantly higher percentage of their reduction in beds being due to shrinkage (72%) while Southeast has a significantly higher percentage of reductions in beds due to factility closures (52%).

<br>

```{r bed change due to closures or shrinkage planning region, echo=FALSE}
bed.change.shrink.pr <- fac.nh.nf2.beds.2005.2024 %>%
  filter(shrunk.closure %in% c("Shrink", "Closure")) %>%
  group_by(planning.region, shrunk.closure) %>%
  summarize(bed.change = sum(bed.change)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(pct = bed.change / sum(bed.change)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

bed.change.shrink.pr.plot <- ggplot(bed.change.shrink.pr, aes(planning.region, pct, fill = shrunk.closure, group = shrunk.closure)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(planning.region, "\n2024", "\nBed reduction due to ", shrunk.closure, ": ", comma(bed.change), "\nPercent of total decline: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of bed reduction.", subtitle = "A large percentage of the reduction in skilled nursing beds is\nfrom facilities shrinking.")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = bed.change.shrink.pr.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### EDR

As we drill down to lower geographic areas, we do begin to see differences from the larger patterns.

* Northwest: EDR 1 has significantly larger percentage of bed reductions due to facility closures while EDR 2 and 4 have a significantly higher percentage of reductions due to shrinkages.
* Central:A large marjority of the reductions in EDR 6E are due to facility closures (66.4%). 100% of reductions in EDR 7W are due to shrinkages.
* Southwest: EDR 8 has a significantly higher percentage of reductions due to facility closures while EDR 9 has a significantly higher percentage of reductions due to shrinkage.

Overall, this is showing a bit more volatility in the rural regions.

<br>

```{r bed change due to closures or shrinkage edr, echo=FALSE}
bed.change.shrink.edr <- fac.nh.nf2.beds.2005.2024 %>%
  filter(shrunk.closure %in% c("Shrink", "Closure")) %>%
  group_by(edr, planning.region, shrunk.closure) %>%
  summarize(bed.change = sum(bed.change)) %>%
  ungroup() %>%
  group_by(edr, planning.region) %>%
  mutate(pct = bed.change / sum(bed.change)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         edr = str_sub(edr, 1, 6),
         edr = trimws(edr, which = "both"))

bed.change.shrink.edr.plot <- ggplot(bed.change.shrink.edr, aes(edr, pct, fill = shrunk.closure, group = shrunk.closure)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free_x") +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(edr, "\n2024", "\nBed reduction due to ", shrunk.closure, ": ", comma(bed.change), "\nPercent of total decline: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of bed reduction.", subtitle = "There is more variance in reduction due to closure or\nshrinkage at a lower geographic level.")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = bed.change.shrink.edr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### RUCA

Okay, this is getting interesting. This definitely shows that entirely rural counties are experiencing reductions in beds due to facility closures are a much higher rate than other county types.

<br>

```{r bed change due to closures or shrinkage ruca, echo=FALSE}
bed.change.shrink.ruca <- fac.nh.nf2.beds.2005.2024 %>%
  filter(shrunk.closure %in% c("Shrink", "Closure")) %>%
  group_by(Dem_Desc, shrunk.closure) %>%
  summarize(bed.change = sum(bed.change)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(pct = bed.change / sum(bed.change)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

bed.change.shrink.ruca.plot <- ggplot(bed.change.shrink.ruca, aes(Dem_Desc, pct, fill = shrunk.closure, group = shrunk.closure)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Dem_Desc, "\n2024", "\nBed reduction due to ", shrunk.closure, ": ", comma(bed.change), "\nPercent of total decline: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of bed reduction.", subtitle = "Entirely rural counties have a significantly higher percentage\nof reductions in beds due to facility closures.")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = bed.change.shrink.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```


<br>

### Counties

The maps below that there is definitely a larger share of bed reductions occurring due to closures in Northwest

<br>

```{r bed change due to closures or shrinkage counties, echo=FALSE}
bed.change.shrink.county <- fac.nh.nf2.beds.2005.2024 %>%
  filter(shrunk.closure %in% c("Shrink", "Closure")) %>%
  group_by(Name, countyfp, shrunk.closure) %>%
  summarize(bed.change = sum(bed.change)) %>%
  ungroup()  %>%
  complete(Name, shrunk.closure) %>%
  group_by(Name) %>%
  fill(countyfp, .direction = "downup") %>%
  ungroup() %>%
  mutate(bed.change = ifelse(is.na(bed.change), 0, bed.change)) %>%
  group_by(Name, countyfp) %>%
  mutate(pct = bed.change / sum(bed.change, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(pct = ifelse(is.nan(pct), 0, pct),
         data_id = seq(n()),
         pct.bins = cut(pct,
                        breaks = c(-1, .0000000001, .25, .5, .75, .99999999, 1.2),
                        labels = c("0%", "1%-25%", "25%-50%", "50%-75%", "75%-99%", "100%"))) %>%
  right_join(mn_counties[,c(5,7)], by = "countyfp")

bed.change.shrink.county.plot <- ggplot(bed.change.shrink.county) +
  facet_wrap(~shrunk.closure, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.bins, data_id = data_id, tooltip = paste(Name, "\n2024", "\nBed reductions due to ", shrunk.closure, ": ", comma(bed.change), "\nPercent of total bed reductions: ", percent(pct, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 7, "PuBu")) +
  labs(title = "Percent share of bed reductions") +
  theme(legend.box.margin = margin(50, 0, 0, -50),
        text = element_text(size = 18))


girafe(ggobj = bed.change.shrink.county.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>