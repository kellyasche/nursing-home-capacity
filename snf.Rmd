---
title: "Data prep and analysis of skilled nursing facilities"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", linewidth  = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", linewidth = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#654C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4565b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4565b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Shapefiles/County shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```


# Data Prep

First, let's load in the master file.

```{r load master file}
master.original <- read_csv("Data/Facilities/Master-provider-directory-2005-2024.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.original %>%
  names() %>%
  kable()

master.age.65plus.county <- read_csv("Data/Population/Age/Master-age-65plus-county.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.age.projections.65plus.county <- read_csv("Data/Population/Age/Master-age-projections-65plus-county.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

<br>

There are `r comma(ncol(master.original))` columns in the dataset and `r comma(nrow(master.original))` rows. Each row is a facility tied to a specific year.

The following table defines all of the columns.

```{r varaiable definition table}
field.outline <- read_excel("Data/Facilities/Field outline.xlsx") %>%
  as_tibble()

datatable(field.outline, class = "cell-border stripe", filter = "top", rownames = FALSE)

```

<br>

With this exploration, the primary data we want are only the skilled nursing facilities and their capacity to provide nursing home beds. This dataset is a bit confusing to try and figure out which column is actually measuring beds. Here are all the columns that seem to have something to do with capacity for which we are concerned here;

* NH_BEDS: State licensed, number of nursing home beds
* SNF_BEDS: Federal medicare, number of skilled nursing facility beds
* SNFNF_BEDS: Federal medicare/medicaid, number of dual skilled nursing facility and nursing facility beds
* NF1_Beds: Federal Medicaid, number of nursing facility beds (Nursing home)
* NF2_Beds: Federal Medicaid, number of nursing facility beds (Boarding care home)

I think we need better descriptions here to decipher what is going on because some of these a sub-categories of others. For example, NH_BEDS seems to be the sum of SNF_BEDS and SNFNF_Beds.

* NH_BEDS = SNF_BEDS + SNFNF_BEDS + NF1_BEDS

So what is the difference between those three that add up to NH_BEDS? 
* SNF_BEDS =  are only medicare eligible beds.
* SNFNF_BEDS =  are medicare and medicaid eligible beds.
* NF1_BEDS = are only medicaid beds

And all of these are located in skilled nursing facilities. NF2_BEDS is not included in the NH_BEDS. Why? These beds are not in a skilled nursing facility, but rather in a "group home" which is a small, private facility. 

So with this figured out, let's create a dataset that has all five of these columns because it will be good to be able to split these out further in the analysis.

```{r create master snf beds}
master.snf <- master.original %>%
  select(year, LIC_TYPE, NH_BEDS, SNF_BEDS, SNFNF_BEDS, NF1_BEDS, NF2_BEDS, HFID, NAME, CITY, STATE, ZIP, COUNTY_NAME, countyfp, Dem_Desc, edr, planning.region)

master.snf
```

<br>

# Change in skilled nursing beds{.tabset}

This section will explore what changes have taken place in the number of licensed skilled nursing beds by region and rurality. For this exploration we will use the sum of NH_BEDS + NF2_BEDS.

```{r sn beds master}
nh.nf2.beds.master <- master.snf %>%
  mutate(nh.nf2.beds = NH_BEDS + NF2_BEDS) %>%
  filter(nh.nf2.beds > 0)

names(nh.nf2.beds.master)

```

There are `r comma(nrow(nh.nf2.beds.master))` facilities with these types of beds available in Minnesota.


<br>

## Minnesota

The number of nursing home beds has decreased 33% since 2005 in the state of Minnesota. Overall in Minnesota, the number of skilled nursing home and facility beds available has declined by 33.3%, from 37,718 beds in 2005 to 25,173 in 2024.

The largest percentage declines have occurred in Northwest (43.4%) and Southwest Minnesota (-38.3%). In particular, the EDRs 5 (-55%) and 4 (-40%) in Northwest Minnesota, and EDRs 8 (-40%) and 9 (-38%) in Southwest Minnesota. 

Some of the counties with very high percentage declines include;

* Cass (-93%)
* Grant (-65%)
* Swift (-69%)
* Pine (-65%)
* Faribault (-63%)

<br>

```{r nh and nf2 beds mn, echo = FALSE}
nh.nf2.beds.mn <- nh.nf2.beds.master %>%
  group_by(year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)],
         data_id = as.character(seq(n()))) 

nh.nf2.beds.mn.plot <- ggplot(nh.nf2.beds.mn, aes(year, nh.nf2.beds)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(y = nh.nf2.beds / 2, label = paste("% change\nsince 2005\n", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = "")), color = "black") +
  geom_label(aes(label = comma(nh.nf2.beds)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of nursing home beds (nursing and boarding homes)")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.mn.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## Planning Region

The planning regions with the largest percentage declines in the number of beds are Northwest (-43%) and Southwest (-38%). The lowest was actually in Central Minnesota with a decline of -25.2%. 

<br>

```{r nh and nf2 beds pr, echo = FALSE}
nh.nf2.beds.pr <- nh.nf2.beds.master %>%
  filter(!is.na(planning.region)) %>%
  group_by(year, planning.region) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.pr.plot <- ggplot(data = filter(nh.nf2.beds.pr, year != 2005), aes(as.character(year), nh.nf2.beds.pct.change)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(planning.region, "\n", "Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(y = nh.nf2.beds.pct.change / 2, label = percent(nh.nf2.beds.pct.change, accuracy = .1)), color = "black") +
  labs(x="", y = "", color="", title = "Percent change in the number of nursing home beds (nursing and\nboarding homes) since 2005")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = color.pr) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

## EDR

These EDRs all have declines in the number of beds that exceed the state decline;

* EDR 5 - North Central: -55%
* EDR 4 - West Central: -40%
* EDR 7E - East Central: -37%
* EDR 8 - Southwest: -40%
* EDR 9 - South Central: -38%

These EDRs reside in either Norhwest or Southwest Minnesota.

<br>

```{r nh and nf2 beds edr, echo = FALSE}
nh.nf2.beds.edr <- nh.nf2.beds.master %>%
  filter(!is.na(edr)) %>%
  group_by(year, edr, planning.region) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(edr, planning.region) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.edr.plot <- ggplot(data = filter(nh.nf2.beds.edr, year != 2005), aes(as.character(year), nh.nf2.beds.pct.change, fill = edr, group = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(edr, "\n", "Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(nh.nf2.beds.pct.change, accuracy = .1)), color = "black", position = position_dodge(width = .9), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent change in the number of nursing home beds (nursing and\nboarding homes) since 2005")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = color.edr,
                    guide = guide_legend(ncol = 3)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

## County

This clearly shows that the more rural a group of counties is, the larger the decline in the number of licensed beds.

<br>

```{r nh and nf2 beds county, echo = FALSE}
nh.nf2.beds.county <- nh.nf2.beds.master %>%
  filter(!is.na(countyfp)) %>%
  group_by(year, countyfp, COUNTY_NAME) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(countyfp, COUNTY_NAME) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  filter(year == max(year)) %>% 
  left_join(mn_counties[,c(5,7)], by = "countyfp") %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.county.map <- ggplot(nh.nf2.beds.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = nh.nf2.beds.pct.change, data_id = countyfp, tooltip = paste(COUNTY_NAME, "\nNumber of beds: ", comma(nh.nf2.beds), "\nPercent change in the number of beds since 2005: ", percent(nh.nf2.beds.pct.change, accuracy = .1) , sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "Reds", direction = -1, labels = scales::percent) +
  labs(title = "Percent change in number of beds since 2005") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = nh.nf2.beds.county.map, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  



```


<br>

## RUCA

This clearly shows that the more rural a group of counties is, the larger the decline in the number of licensed beds.

<br>

```{r nh and nf2 beds ruca, echo = FALSE}
nh.nf2.beds.ruca <- nh.nf2.beds.master %>%
  filter(!is.na(Dem_Desc)) %>%
  group_by(year, Dem_Desc) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.ruca.plot <- ggplot(data = filter(nh.nf2.beds.ruca, year != 2005), aes(as.character(year), nh.nf2.beds.pct.change)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Dem_Desc, "\n", "Nursing home beds and Boarding Care Nursing Beds", "\n", year, "\nNumber of beds: ", comma(nh.nf2.beds), "\nChange since ", min(nh.nf2.beds.mn$year), ": ", percent(nh.nf2.beds.pct.change, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(nh.nf2.beds.pct.change, accuracy = .1)), color = "black", position = position_dodge(width = .9), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent change in the number of nursing home beds (nursing and\nboarding homes) since 2005")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = color.ruca,
                    guide = guide_legend(ncol = 3)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

# Availability per 65+ resident{.tabset}

The average age of nursing home residents is about 83, however, rural folks tend to get sicker earlier so let's use the 65+ age cohort to measure the ratio of residents per bed capacity. 

In addition, we have access to the number of 65+ projections for each county using the MN State Demographic Center estimates. I will include those in there. For those, we will just assume that the bed capacity will remain constant from 2024 onwards.

The charts below show that there has been a significant increase in the number of 65+ individuals per bed capacity all across Minnesota. In fact, not a single county has less 65+ per bed capacity in 2024 compared to 2005. And the number of 65+ per bed will peak across the state between 2030 and 2035.

However, some areas have higher 65+ individuals per bed capacity than others. The seven county metro has the highest out of all the planning regions, but this is largely driven by four counties - Anoka, Washington, Dakota, Carver. In Greater Minnesota, the highest number of 65+ per bed capacity is in the central lakes - Cass, Crow Wing and Hubbard. 

Overall, Southwest Minnesota seems to have the lowest values of 65+ per bed capacity.

<br>

```{r combine snf beds and age 65 plus, echo=FALSE}
age65plus.projections.county <- master.age.projections.65plus.county %>%
  filter(year %in% c(2030, 2035, 2040))

age.65plus.old.projections.county <- age65plus.projections.county %>%
  rbind(master.age.65plus.county)

nh.nf2.beds.age.65plus.county <- nh.nf2.beds.master %>%
  filter(!is.na(countyfp)) %>%
  group_by(year, countyfp, COUNTY_NAME) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds)) %>%
  ungroup() %>%
  group_by(countyfp, COUNTY_NAME) %>%
  arrange(year) %>%
  mutate(nh.nf2.beds.pct.change = (nh.nf2.beds - nh.nf2.beds[year == min(year)]) / nh.nf2.beds[year == min(year)]) %>%
  ungroup() %>%
  filter(year > 2005) %>%
  select(year, countyfp, COUNTY_NAME, nh.nf2.beds) %>%
  pivot_wider(names_from = year, values_from = nh.nf2.beds) %>%
  mutate(`2030` = `2024`,
         `2035` = `2024`,
         `2040` = `2024`) %>%
  pivot_longer(names_to = "year", values_to = "nh.nf2.beds", `2010`:`2040`) %>%
  mutate(year = as.integer(year)) %>%
  left_join(age.65plus.old.projections.county, by = c("countyfp", "year")) 

```

<br>

## Minnesota

The number of people 65+ per beds has increased significantly since 2005. By 2024 it increased from 20.4 people 65+ per bed capacity to 41.9 people 65+.

<br>

```{r 65 plus per nh nf2 bed MN, echo=FALSE}
nh.nf2.beds.age.65plus.mn <- nh.nf2.beds.age.65plus.county %>%
  group_by(year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() 

nh.nf2.beds.age.65plus.mn.plot <- ggplot(nh.nf2.beds.age.65plus.mn, aes(as.character(year), age.65plus.nh.nf2.beds)) +
  geom_col_interactive(position = "dodge", aes(data_id = year, tooltip = paste("Minnesota", "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%\nfrom 2010 to 2024")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.mn.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```
<br>

## Planning Region

The largest changes in the number of 65+ individuals per nh and NF2 bed capacity has been in the seven-county metro. Southwest has had the lowest.

<br>

```{r 65 plus per nh nf2 bed pr, echo=FALSE}
nh.nf2.beds.age.65plus.pr <- nh.nf2.beds.age.65plus.county %>%
  group_by(planning.region, year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.age.65plus.pr.plot <- ggplot(nh.nf2.beds.age.65plus.pr, aes(as.character(year), age.65plus.nh.nf2.beds)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## EDR

There has been some EDR's in Greater Minnesota that are experiencing high levels of individuals 65 or older per NH and NF2 bed capacity;

* EDR 2: Has been high for a while and is currently at 19 individuals per available capacity.
* EDR 5: Super high ratio - currently at 25 individuals per 1 NH and NF2 bed capacity.
* EDR 7E: 21 individuals per 1 bed capacity
* EDR 7W: 19 individuals per 1 bed capacity

Southwest is surprisingly low. 


<br>

```{r 65 plus per nh nf2 bed edr, echo=FALSE}
nh.nf2.beds.age.65plus.edr <- nh.nf2.beds.age.65plus.county %>%
  group_by(edr, planning.region, year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.age.65plus.edr.plot <- ggplot(nh.nf2.beds.age.65plus.edr, aes(as.character(year), age.65plus.nh.nf2.beds, group = edr, fill = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(edr, "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%")+
  scale_y_continuous(labels=scales::comma)+
  scale_fill_manual(values = color.edr,
                    guide = guide_legend(ncol = 3)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## County

At the county level, there is a considerable higher number of 65 residents in the central lakes region per 1 Nh and NF2 bed capacity. 

* Hubbarb: 114
* Cass: 270.6
* Crow Wing: 103.0
* Pine: 1387

In addition, a couple of the suburbs have significantly higher number of 65+ per bed capacity.

* Anoka: 147.7
* Washington: 80.4
* Dakota: 89.1
* Carver: 104.3

<br>

```{r 65 plus per nh nf2 bed county, echo=FALSE}
nh.nf2.beds.age.65plus.county.map <- nh.nf2.beds.age.65plus.county %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds,
         age.65plus.nh.nf2.beds.bins = cut(age.65plus.nh.nf2.beds,
                                           breaks = c(0, 20, 40, 60, 80, 2000),
                                           labels = c("1-20 individuals 65+", "20-40 individuals 65+", "40-60 individuals 65+", "60-80 individuals 65+", "More than 80 individuals 65+")))%>%
group_by(countyfp) %>%
  mutate(better.worse = ifelse(age.65plus.nh.nf2.beds > age.65plus.nh.nf2.beds[year == min(year)], "Worse", "Better")) %>%
  ungroup() %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")


nh.nf2.beds.age.65plus.county.map.plot <- ggplot(data = filter(nh.nf2.beds.age.65plus.county.map, year == 2024)) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = age.65plus.nh.nf2.beds.bins, data_id = countyfp, tooltip = paste(COUNTY_NAME, "\nYear: ", year, "\nIndividuals aged 65 plus: ", comma(age.65plus), "\nNumber of NH and NF2 bed capacity: ", comma(nh.nf2.beds), "\nNumber of 65 plus per 1 bed: ", comma(age.65plus.nh.nf2.beds, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "Reds")) +
  labs(title = "Number of individuals 65 or older per 1 NH and NF2 bed capacity",
       subtitle = "Highest number of 65+ in 2024 is in the central lakes and suburbs.") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))
   

girafe(ggobj = nh.nf2.beds.age.65plus.county.map.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
```

<br>

## RUCA

As expected, the more rural, the less people 65+ per bed capacity. 

<br>

```{r 65 plus per nh nf2 bed ruca, echo=FALSE}
nh.nf2.beds.age.65plus.ruca <- nh.nf2.beds.age.65plus.county %>%
  group_by(Dem_Desc, year) %>%
  summarize(nh.nf2.beds = sum(nh.nf2.beds, na.rm = TRUE),
            age.65plus = sum(age.65plus)) %>%
  mutate(age.65plus.nh.nf2.beds = age.65plus / nh.nf2.beds) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

nh.nf2.beds.age.65plus.ruca.plot <- ggplot(nh.nf2.beds.age.65plus.ruca, aes(as.character(year), age.65plus.nh.nf2.beds)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nNumber of NH and NF2 beds = ", comma(nh.nf2.beds), "\nPopulation age 65 plus: ", comma(age.65plus), "\nNumber of 65 plus per available bed: ", comma(age.65plus.nh.nf2.beds), sep = ""))) +
  geom_label(aes(label = comma(age.65plus.nh.nf2.beds, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Number of 65 plus individuals per NH and NF2 bed available", subtitle = "The number of people aged 65+ per nursing home bed capacity has increased by 81%")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = nh.nf2.beds.age.65plus.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

# Medicare vs Medicaid beds

The next question is whether any type of bed with atteched payment eligibilty has changed more than another. 