---
title: "Supply and Demand for SNF"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", linewidth  = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", linewidth = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#654C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4565b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.edr.simple <- c("EDR 1" = "#b3cde3", "EDR 2" = "#8c96c6", "EDR 3" = "#fe9929", "EDR 4" = "#8856a7", "EDR 5" = "#810f7c", "EDR 6E" = "#e5f5f9", "EDR 6W" = "#bdc9e1", "EDR 7E" = "#99d8c9", "EDR 7W" = "#2ca25f", "EDR 8" = "#74a9cf", "EDR 9" = "#0570b0", "EDR 10" = "#d7301f", "EDR 11" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4565b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("/Users/kellyasche/Library/CloudStorage/GoogleDrive-kasche@ruralmn.org/My Drive/Data Prep/R Projects/Shapefiles/County shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r load master file}
master.original <- read_csv("Data/Facilities/Master-provider-directory-2005-2024.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         edr.simple = fct_relevel(edr.simple, "EDR 1", "EDR 2", "EDR 3", "EDR 4", "EDR 5", "EDR 6E", "EDR 6W", "EDR 7E", "EDR 7W", "EDR 8", "EDR 9", "EDR 10", "EDR 11"))
```

```{r create master snf beds}
master.snf <- master.original %>%
  select(year, LIC_TYPE, NH_BEDS, SNF_BEDS, SNFNF_BEDS, NF1_BEDS, NF2_BEDS, HFID, NAME, CITY, STATE, ZIP, COUNTY_NAME, countyfp, Dem_Desc, edr, planning.region) %>%
  left_join(counties.regions[,c(1,8)], by = "countyfp")

datatable(master.snf, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) 
```

<br>

# Summary

<br>

# Preparing age projections

First we need to figure out our population projections by age group. Since the information I have in the percentage of elderly that utilize long term care facilities is from the [Profile of Older Americans](https://acl.gov/sites/default/files/Profile%20of%20OA/ACL_ProfileOlderAmericans2023_508.pdf#page=7), which states the following;

> “In 2022, a relatively small number of people (1.3 million) 65 and older lived in nursing homes. However, the percentage of the population increased with age, ranging from 1% for people 65-74 and 3% for people 75-84 to 8% for people over 85.” - Profile of Older Americans

So, let's put together the 2024 population and projections for those three age groups. I will also filter it so it only has the years 2024, 2030, 2035, 2040, 2045 and 2050.

<br>

```{r master age groups}
age.group.original <- read_csv("Data/Population/Age/Master-age-group-projections-county.csv") %>%
  left_join(counties.regions[,c(1,8)], by = "countyfp") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         edr.simple = fct_relevel(edr.simple, "EDR 1", "EDR 2", "EDR 3", "EDR 4", "EDR 5", "EDR 6E", "EDR 6W", "EDR 7E", "EDR 7W", "EDR 8", "EDR 9", "EDR 10", "EDR 11"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.age.group <- age.group.original 

datatable(master.age.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:ncol(master.age.group))))) 

```

<br>

The age group dataset has `r comma(nrow(master.age.group))` rows and `r comma(ncol(master.age.group))` columns.

<br>

# Demand{.tabset}

Using the percentages provided by the Profile of Older Americans, we will create a new column that estimates demand for long-term care.

<br>

```{r demand ltc}
ltc.demand.county <- master.age.group %>%
  mutate(ltc.demand = ifelse(age.group == "65_74", pop * .01,
                             ifelse(age.group == "75_84", pop * .03, pop * .08))) %>%
  group_by(year, countyfp, Name, planning.region, edr, edr.simple, Dem_Desc) %>%
  summarize(pop.65plus = sum(pop),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() 
```

<br>

The following tabset provides a table of the projected demand for long term care among 65+ population for each region and rural-urban category.

What is shows is that demand for long-term care is already high in our most rural counties where it's about to peak, especially by 2035. In our more urban counties, it's going to peak significantly later - after 2050.

<br>

## Minnesota

Demand for long-term care in Minnesota will increase by 45% by 2050. The largest growth will occur between 2025 and 2035 and then it begins to plateau.

<br>

```{r ltc demand MN, echo=FALSE}
ltc.demand.mn <- ltc.demand.county %>%
  group_by(year) %>%
  summarize(pop.65plus = sum(pop.65plus),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  mutate(ltc.demand.index = (ltc.demand - ltc.demand[year == min(year)]) / ltc.demand[year == min(year)]) %>%
  mutate(data_id = seq(n()))

datatable(ltc.demand.mn, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatCurrency(2, "", digits = 0) %>%
  formatRound(3, digits = 0) %>%
  formatPercentage(4, digits = 1)


ltc.demand.mn.plot <- ggplot(ltc.demand.mn, aes(year, ltc.demand.index)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nPopulation 65+: ", comma(pop.65plus), "\nEstimated demand for long term care: ", comma(ltc.demand), "\nChange in demand since ", min(year), ": ", percent(ltc.demand.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in long term care demand")+
  geom_label_repel(data = filter(ltc.demand.mn, year == max(year)), aes(label = percent(ltc.demand.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = ltc.demand.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## Planning Region

The chart below shows that the largest growth in demand will occur in the seven county metro, particularly in the later years. However, by 2030 demand will be somewhat similar across all planning regions. After 2030, rural Minnesota begins to level off a bit, especially in Southwest and Northeast Minnesota.

<br>

```{r ltc demand pr, echo=FALSE}
ltc.demand.pr <- ltc.demand.county %>%
  group_by(year, planning.region) %>%
  summarize(pop.65plus = sum(pop.65plus),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(ltc.demand.index = (ltc.demand - ltc.demand[year == min(year)]) / ltc.demand[year == min(year)]) %>%
  ungroup %>%
  mutate(data_id = seq(n()))

datatable(ltc.demand.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatCurrency(3, "", digits = 0) %>%
  formatRound(4, digits = 0) %>%
  formatPercentage(5, digits = 1)


ltc.demand.pr.plot <- ggplot(ltc.demand.pr, aes(year, ltc.demand.index, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nPopulation 65+: ", comma(pop.65plus), "\nEstimated demand for long term care: ", comma(ltc.demand), "\nChange in demand since ", min(year), ": ", percent(ltc.demand.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in long term care demand")+
  geom_label_repel(data = filter(ltc.demand.pr, year == max(year)), aes(label = percent(ltc.demand.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = ltc.demand.pr.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## EDR

The EDRs have a lot of variation in long term care demand. Although the seven county metro still has the highest demand, it's closed followed by EDR 5 and EDR 7W. 

<br>

```{r ltc demand edr, echo=FALSE}
ltc.demand.edr <- ltc.demand.county %>%
  group_by(year, edr.simple, planning.region) %>%
  summarize(pop.65plus = sum(pop.65plus),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(edr.simple, planning.region) %>%
  mutate(ltc.demand.index = (ltc.demand - ltc.demand[year == min(year)]) / ltc.demand[year == min(year)]) %>%
  ungroup %>%
  mutate(data_id = seq(n()))

datatable(ltc.demand.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatCurrency(4, "", digits = 0) %>%
  formatRound(5, digits = 0) %>%
  formatPercentage(6, digits = 1)


ltc.demand.edr.plot <- ggplot(ltc.demand.edr, aes(year, ltc.demand.index, color = edr.simple)) +
  facet_wrap(~planning.region, ncol = 2, scales = "free_x") +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr.simple, "\nYear: ", year, "\nPopulation 65+: ", comma(pop.65plus), "\nEstimated demand for long term care: ", comma(ltc.demand), "\nChange in demand since ", min(year), ": ", percent(ltc.demand.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in long term care demand")+
  geom_label_repel(data = filter(ltc.demand.edr, year == max(year)), aes(label = percent(ltc.demand.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  scale_color_manual(values = color.edr.simple) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = ltc.demand.edr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## RUCA

Rural-urban categories also show significant variation. Our entirely rural areas will have peak demand in 2035 with a 6.25% increase from 2024. Town/rural mix and Urban/town/rural mix counties will peak in 2045 with an increase in demand of nearly 25%. Entirely urban counties will continue to peak until 2050 with an increase in demand of 60%!

<br>

```{r ltc demand ruca, echo=FALSE}
ltc.demand.ruca <- ltc.demand.county %>%
  group_by(year, Dem_Desc) %>%
  summarize(pop.65plus = sum(pop.65plus),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(ltc.demand.index = (ltc.demand - ltc.demand[year == min(year)]) / ltc.demand[year == min(year)]) %>%
  ungroup %>%
  mutate(data_id = seq(n()))

datatable(ltc.demand.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatCurrency(3, "", digits = 0) %>%
  formatRound(4, digits = 0) %>%
  formatPercentage(5, digits = 1)


ltc.demand.ruca.plot <- ggplot(ltc.demand.ruca, aes(year, ltc.demand.index, color = Dem_Desc)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nPopulation 65+: ", comma(pop.65plus), "\nEstimated demand for long term care: ", comma(ltc.demand), "\nChange in demand since ", min(year), ": ", percent(ltc.demand.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Change in long term care demand")+
  geom_label_repel(data = filter(ltc.demand.ruca, year == max(year)), aes(label = percent(ltc.demand.index, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_color_manual(values = color.ruca) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 5)) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = ltc.demand.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## County

The county map shows an interesting pattern. Along the western side of Minnesota, counties have already peaked in demand or will peak by 2030. The largest increases in demand occur in the seven county suburbs, and in the central lakes region. Cass and Crow Wing counties will peak in 2050 with a 50% to 75% increase in demand. The largest increase is in Carver County with an increase of 174%.

<br>
```{r ltc demand county, echo=FALSE}
ltc.demand.county.new <- ltc.demand.county %>%
  filter(year %in% c(2030, 2035, 2040, 2045, 2050)) %>%
  group_by(countyfp) %>%
  mutate(ltc.demand.index = (ltc.demand - ltc.demand[year == min(year)]) / ltc.demand[year == min(year)]) %>%
  ungroup() %>%
  select(year, countyfp, Name, pop.65plus, ltc.demand, ltc.demand.index) %>%
  mutate(data_id = seq(n())) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")


datatable(ltc.demand.county.new, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatCurrency(4, "", digits = 0) %>%
  formatRound(5, digits = 0) %>%
  formatPercentage(6, digits = 1)


ltc.demand.county.new.plot <- ggplot(ltc.demand.county.new) +
  facet_wrap(~year, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = ltc.demand.index, data_id = data_id, tooltip = paste(Name, "\nYear: ", year, "\nPopulation 65+: ", comma(pop.65plus), "\nNumber needing long term care: ", comma(ltc.demand), "\nPercent change in long term care demand since ", min(year), ": ", percent(ltc.demand.index, accuracy = .1), sep = ""))) +
  scale_fill_fermenter(palette = "PuBu", direction = 1,
                       labels = scales::label_percent()) +
  theme_sf+
  theme(legend.position = "right",
        text = element_text(size = 18))

girafe(ggobj = ltc.demand.county.new.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```


<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

It might be nice to see the differences in when demand will peak across the state and to what extent that demand will be increased.

Not surprisingly, the numbers below clarify how significant the peak in long term care will differ across rural-urbanness. Our most rural counties will peak in the mid-2030s while the more urban counties peak around 2047 to 2055.

<br>

## Minnesota

The peak long term care demand for all of Minnesota will be in 2047 with 37,336 people.

<br>

```{r peak mn, echo=FALSE}
peak.ltc.demand.mn <- age.group.original %>%
  mutate(ltc.demand = ifelse(age.group == "65_74", pop * .01,
                             ifelse(age.group == "75_84", pop * .03, pop * .08))) %>%
  group_by(year) %>%
  summarize(pop.65plus = sum(pop),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  filter(ltc.demand == max(ltc.demand))
  
datatable(peak.ltc.demand.mn) %>%
  formatCurrency(2:3, "", digits = 0) 
```

<br>

## Planning Region

The year each region will peak in demand for long term care varies significantly. Northeast will peak first in 2041 with 2,216 people. This is followed immediately by Southwest with 2,568 people. Northwest and and Southeast peak in the same year with 2047. Significantly later are Central and the Seven County Metro with a peak at 2055.

<br>

```{r peak pr, echo=FALSE}
peak.ltc.demand.pr <- age.group.original %>%
  mutate(ltc.demand = ifelse(age.group == "65_74", pop * .01,
                             ifelse(age.group == "75_84", pop * .03, pop * .08))) %>%
  group_by(year, planning.region) %>%
  summarize(pop.65plus = sum(pop),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  filter(ltc.demand == max(ltc.demand)) %>%
  ungroup()
  
datatable(peak.ltc.demand.pr) %>%
  formatCurrency(3:4, "", digits = 0) 
```

<br>

## EDR

Breaking this down by EDR really shows the variation across EDRs. It's important to highlight that our most rural EDR's peak first. EDR 1, 2, 8, 6W, and 3 all peak at or before 2041. Then there's a pretty wide gap until EDR 4 and 6E with 2047.

One I can't really figure out is EDR 5 - North Central - that won't peak until 2055.

<br>

```{r peak edr, echo=FALSE}
peak.ltc.demand.edr <- age.group.original %>%
  mutate(ltc.demand = ifelse(age.group == "65_74", pop * .01,
                             ifelse(age.group == "75_84", pop * .03, pop * .08))) %>%
  group_by(year, edr) %>%
  summarize(pop.65plus = sum(pop),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(edr) %>%
  filter(ltc.demand == max(ltc.demand)) %>%
  ungroup()
  
datatable(peak.ltc.demand.edr) %>%
  formatCurrency(3:4, "", digits = 0) 
```

<br>

## RUCA

As expected, our most rural county group will peak significantly sooner than other counties. By 2037, the entirely rural county group will peak with their long term care demand with 689 people. From there, town/rural mix and urban/town/rural mix peak in 2047. Entirely urban counties peak in 2055.

<br>

```{r peak ruca, echo=FALSE}
peak.ltc.demand.ruca <- age.group.original %>%
  mutate(ltc.demand = ifelse(age.group == "65_74", pop * .01,
                             ifelse(age.group == "75_84", pop * .03, pop * .08))) %>%
  group_by(year, Dem_Desc) %>%
  summarize(pop.65plus = sum(pop),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  filter(ltc.demand == max(ltc.demand)) %>%
  ungroup()
  
datatable(peak.ltc.demand.ruca) %>%
  formatCurrency(3:4, "", digits = 0) 

```

<br>

## County

The map below shows that the peak year for nursing home care will be before 2030 for many counties on the Northwest and Southwest regions of Minnesota. While around the seven county metro, along the I94 corridor and in Southeast Minnesota long term care will peak after 2040 and even 2045.

<br>

```{r peak county, echo=FALSE}
peak.ltc.demand.county <- age.group.original %>%
  mutate(ltc.demand = ifelse(age.group == "65_74", pop * .01,
                             ifelse(age.group == "75_84", pop * .03, pop * .08))) %>%
  group_by(year, countyfp, Name, Dem_Desc, edr, planning.region) %>%
  summarize(pop.65plus = sum(pop),
            ltc.demand = sum(ltc.demand)) %>%
  ungroup() %>%
  group_by(Name, countyfp, Dem_Desc, edr, planning.region) %>%
  filter(ltc.demand == max(ltc.demand)) %>%
  ungroup() %>%
  mutate(year.bins = cut(year,
                         breaks = c(0, 2030, 2035, 2040, 2045, 2060),
                         labels = c("Before 2030", "2030 to 2035", "2035 to 2040", "2040 to 2045", "After 2045")),
         data_id = seq(n())) %>%
  left_join(mn_counties[,c(5,7)], by = "countyfp")

datatable(peak.ltc.demand.county) %>%
  formatCurrency(7:8, "", digits = 0) 

peak.ltc.demand.county.plot <- ggplot(peak.ltc.demand.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = year.bins, data_id = countyfp, tooltip = paste(Name, "\nYear long term care will peak: ", year, "\nDemand: ", comma(ltc.demand), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu")) +
  labs(title = "Year that demand for nursing home care will peak") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = peak.ltc.demand.county.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

# Demand vs. supply

The next big issue is if there's a gap in demand vs supply in long term care. I'm going to assess this question via three scenarios;

1. If capacity for nursing home holds steady.
2. If declines continue at current pace.
3. The difference if nursing homes can at least solve their shrinkage issues.

<br>

## Demand vs supply holding steady{.tabset}

First, I need to put together the nursing home capacity for 2024. For capacity, we will use the sum of NH_BEDS and NF2_BEDS. 

NH_BEDS = SNF_BEDS + SNFNF_BEDS + NF1_BEDS

* SNF_BEDS = are only medicare eligible beds.
* SNFNF_BEDS = are medicare and medicaid eligible beds.
* NF1_BEDS = are only medicaid beds

NF2_BEDS are Federal Medicaid nursing beds located in boarding care homes.

The charts below show a consistent pattern - our most rural places in Minnesota will, typically, have enough skilled nursing facility beds to meet demand in this scenario while our more urban areas will have significant shortages to meet demand.

<br>

```{r snf capcacity, echo=FALSE}
snf.cap <- master.original %>%
  filter(year == max(year)) %>%
  filter(HFID != 0) %>%
  select(HFID, NAME, COUNTY_NAME, countyfp, NH_BEDS, NF2_BEDS) %>%
  mutate(snf.cap = NH_BEDS + NF2_BEDS) %>%
  rename(County = COUNTY_NAME) %>%
  left_join(counties.regions, by = "countyfp") %>%
  select(-Name)

```

### Minnesota

There will be a consistently growing gap between the capacity of skilled nursing facility beds and demand for them.

<br>

```{r demand vs supply holding steady mn}
supply.demand.steady.mn <- snf.cap %>%
  summarize(snf.cap = sum(snf.cap)) %>%
  cross_join(ltc.demand.mn) %>%
  mutate(snf.supply.demand.diff = snf.cap - ltc.demand,
         data_id = seq(n()))

supply.demand.steady.mn.plot <- ggplot(supply.demand.steady.mn, aes(year, snf.supply.demand.diff)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, sep = ""))) +
  labs(x="", y = "", color="", title = "Difference between the skilled nursing facility\ncapacity and demand.")+
  geom_label_repel(data = filter(supply.demand.steady.mn, year == max(year)), aes(label = comma(snf.supply.demand.diff)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = supply.demand.steady.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### Planning Region

Well, this is interesting. It looks like Northeast and Southwest have enough capacity to get through the baby boomer demand. The other regions will not have such luck.

<br>

```{r demand vs supply holding steady pr}
supply.demand.steady.pr <- snf.cap %>%
  filter(!is.na(planning.region)) %>%
  group_by(planning.region) %>%
  summarize(snf.cap = sum(snf.cap)) %>%
  ungroup() %>%
  right_join(ltc.demand.pr, by = "planning.region") %>%
  mutate(snf.supply.demand.diff = snf.cap - ltc.demand,
         gap.pct.supply = snf.supply.demand.diff / snf.cap,
         data_id = seq(n()))

supply.demand.steady.pr.plot <- ggplot(supply.demand.steady.pr, aes(year, snf.supply.demand.diff, color = planning.region)) +
  facet_wrap(~planning.region, scales = "free_y", ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 2.5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, sep = ""))) +
  labs(x="", y = "", color="", title = "Difference between the skilled nursing facility\ncapacity and demand.")+
  geom_label_repel(data = filter(supply.demand.steady.pr, year == max(year)), aes(label = comma(snf.supply.demand.diff)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = supply.demand.steady.pr.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### EDR

Quite a bit of variation here. 

Northwest: EDR 5 is looking the worst with a significant under supply of skilled nursing facilities.

Central: EDR 7E and 7W are looking to be under supplied.

Southwest: EDR 9 will be under supplied.

<br>

```{r demand vs supply holding steady edr}
supply.demand.steady.edr <- snf.cap %>%
  filter(!is.na(edr)) %>%
  group_by(edr) %>%
  summarize(snf.cap = sum(snf.cap)) %>%
  ungroup() %>%
  mutate(edr.simple = str_sub(edr, 1, 6),
         edr.simple = trimws(edr.simple, which = "both")) %>%
  right_join(ltc.demand.edr, by = "edr.simple") %>%
  mutate(snf.supply.demand.diff = snf.cap - ltc.demand,
         gap.pct.supply = snf.supply.demand.diff / snf.cap,
         data_id = seq(n()))

supply.demand.steady.edr.plot <- ggplot(supply.demand.steady.edr, aes(year, snf.supply.demand.diff, color = edr.simple)) +
  facet_wrap(~planning.region, scales = "free_y", ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 2.5, aes(data_id = data_id, tooltip = paste(edr.simple, "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, sep = ""))) +
  labs(x="", y = "", color="", title = "Difference between the skilled nursing facility\ncapacity and demand.")+
  geom_label_repel(data = filter(supply.demand.steady.edr, year == max(year)), aes(label = comma(snf.supply.demand.diff)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= color.edr.simple,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = supply.demand.steady.edr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### RUCA

As expected, our entirely rural counties look to be solid in terms of providing enough nursing home supply for projected demand. Other county groups won't be so lucky.

<br>

```{r demand vs supply holding steady ruca}
supply.demand.steady.ruca <- snf.cap %>%
  filter(!is.na(Dem_Desc)) %>%
  group_by(Dem_Desc) %>%
  summarize(snf.cap = sum(snf.cap)) %>%
  ungroup() %>%
  right_join(ltc.demand.ruca, by = "Dem_Desc") %>%
  mutate(snf.supply.demand.diff = snf.cap - ltc.demand,
         gap.pct.supply = snf.supply.demand.diff / snf.cap,
         data_id = seq(n()))

supply.demand.steady.ruca.plot <- ggplot(supply.demand.steady.ruca, aes(year, snf.supply.demand.diff, color = Dem_Desc)) +
  facet_wrap(~Dem_Desc, scales = "free_y", ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 2.5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, sep = ""))) +
  labs(x="", y = "", color="", title = "Difference between the skilled nursing facility\ncapacity and demand.")+
  geom_label_repel(data = filter(supply.demand.steady.ruca, year == max(year)), aes(label = comma(snf.supply.demand.diff)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = supply.demand.steady.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

In order to find the severity of the shortages, let's use the gap between demand and supply as a percentage of total supply. This will tell us how much needs to be built on top of the current supply. If there's enough to meet demand, the percentages will be positive.

<br>

### Minnesota

There will be a consistently growing gap between the capacity of skilled nursing facility beds and demand for them.

<br>

```{r demand vs supply holding steady pct mn}
supply.demand.steady.mn <- snf.cap %>%
  summarize(snf.cap = sum(snf.cap)) %>%
  cross_join(ltc.demand.mn) %>%
  mutate(snf.supply.demand.diff = snf.cap - ltc.demand,
         gap.pct.supply = snf.supply.demand.diff / snf.cap,
         data_id = seq(n()))

supply.demand.steady.pct.mn.plot <- ggplot(supply.demand.steady.mn, aes(year, gap.pct.supply)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste("Minnesota", "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, "\nGap as percentage of total supply: ", percent(gap.pct.supply, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Supply vs. demand gap as a percent of total\nsupply")+
  geom_label_repel(data = filter(supply.demand.steady.mn, year == max(year)), aes(label = percent(gap.pct.supply, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = supply.demand.steady.pct.mn.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### Planning Region

The seven county metro has the most severe shortage in this scenario, by a lot!

<br>

```{r demand vs supply holding steady pct pr}
supply.demand.steady.pct.pr.plot <- ggplot(supply.demand.steady.pr, aes(year, gap.pct.supply, color = planning.region)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 2.5, aes(data_id = data_id, tooltip = paste(planning.region, "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, "\nGap as a percent of supply: ", percent(gap.pct.supply, accuracy = .1),sep = ""))) +
  labs(x="", y = "", color="", title = "Supply vs. demand gap as a percent of total\nsupply")+
  geom_label_repel(data = filter(supply.demand.steady.pr, year == max(year)), aes(label = percent(gap.pct.supply)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = supply.demand.steady.pct.pr.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### EDR

Quite a bit of variation here. 

EDR 5 is a bit of an anomaly. In order to meet demand it will have to more than double it's current number of skilled nursing facility beds. 

EDR 7E abd 7W also need to build quite a bit more.

<br>

```{r demand vs supply holding steady pct edr}
supply.demand.steady.pct.edr.plot <- ggplot(supply.demand.steady.edr, aes(year, gap.pct.supply, color = edr.simple)) +
  facet_wrap(~planning.region, scales = "free_y", ncol = 2) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 2.5, aes(data_id = data_id, tooltip = paste(edr.simple, "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, "\nGap as percent of supply: ", percent(gap.pct.supply, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Supply vs. demand gap as a percent of total\nsupply")+
  geom_label_repel(data = filter(supply.demand.steady.edr, year == max(year)), aes(label = percent(gap.pct.supply, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= color.edr.simple,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = supply.demand.steady.pct.edr.plot, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### RUCA

As expected, our entirely rural counties look to be solid in terms of providing enough nursing home supply for projected demand. Other county groups won't be so lucky.

<br>

```{r demand vs supply holding steady pct ruca}
supply.demand.steady.pct.ruca.plot <- ggplot(supply.demand.steady.ruca, aes(year, gap.pct.supply, color = Dem_Desc)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_line(size = 3) +
  geom_point_interactive(size = 2.5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nSNF supply: ", comma(snf.cap), "\nSNF demand: ", comma(ltc.demand), "\nGap in supply vs. demand: ", snf.supply.demand.diff, "\nGap as a percent of total supply: ", percent(gap.pct.supply, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Supply vs. demand gap as a percent of total supply.")+
  geom_label_repel(data = filter(supply.demand.steady.ruca, year == max(year)), aes(label = percent(gap.pct.supply, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2055, 5)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = supply.demand.steady.pct.ruca.plot, width_svg = 7, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

### County


<br>

```{r demand vs supply holding steady pct county}
supply.demand.steady.county <- snf.cap %>%
  group_by(countyfp, County) %>%
  summarize(snf.cap = sum(snf.cap)) %>%
  ungroup() %>%
  right_join(ltc.demand.county, by = "countyfp") %>%
  filter(year %in% c(2030, 2035, 2040, 2045, 2050)) %>%
  mutate(snf.supply.demand.diff = snf.cap - ltc.demand,
         gap.pct.supply = snf.supply.demand.diff / snf.cap,
         data_id = seq(n()),
         gap.pct.supply.bins = cut(gap.pct.supply,
                                   breaks = c(-100, -2, -1, -.5, 0, 100),
                                   labels = c("-200%+", "-200% to -100%", "-100% to -50%", "-50% to 0%", "More supply than demand"))) %>%
  left_join(mn_counties[,c(5,7)], by= "countyfp")

supply.demand.steady.county.map <- ggplot(supply.demand.steady.county) +
  facet_wrap(~year, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = gap.pct.supply.bins, data_id = data_id, tooltip = paste(County, "\nYear: ", year, "\nDemand for nursing facility beds: ", comma(ltc.demand, accuracy = 1), "\nSupply of nursing facility beds: ", comma(snf.cap, accuracy = 1), "\nGap between supply vs. demand: ", comma(snf.supply.demand.diff, accuracy = 1), "\nGap as percent of supply: ", percent(gap.pct.supply, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = rev(brewer.pal(n = 6, "YlOrRd"))) +
  labs(title = "Supply vs. demand gap as a percent of total\nsupply") +
  theme(text = element_text(size = 18),
        legend.position = "bottom")

girafe(ggobj = supply.demand.steady.county.map, width_svg = 7, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>
